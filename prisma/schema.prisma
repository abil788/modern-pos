// ======================================================
// Prisma Schema Documentation
// Modern POS System dengan Kitchen Display System (KDS)
// ======================================================

// Gambaran Umum
// ------------------------------------------------------
// Schema Prisma ini mendefinisikan sistem Point of Sale (POS)
// modern dengan integrasi Kitchen Display System (KDS).
// Dibangun untuk PostgreSQL 14+ dan mendukung:
// - Multi-kasir (multi tenant)
// - Manajemen user & role
// - Inventaris & produk
// - Transaksi penjualan
// - Sistem promo & diskon
// - Workflow dapur (KDS)
// - Audit & keamanan data

// ======================================================
// MODEL INTI
// ======================================================

// ------------------------------------------------------
// Model: Store
// ------------------------------------------------------
// Entitas pusat yang merepresentasikan toko fisik atau digital.
// Semua data operasional terhubung ke Store.
//
// Fitur utama:
// - Informasi toko (nama, alamat, kontak)
// - Konfigurasi mata uang & pajak
// - Branding (logo, warna utama, footer struk)
// - Sistem lisensi (licenseKey)
//
// Relasi:
// - Products
// - Users
// - Transactions
// - Categories
// - Settings
// - Expenses

// ------------------------------------------------------
// Model: User
// ------------------------------------------------------
// Merepresentasikan staf toko dengan kontrol akses berbasis role.
//
// Fitur keamanan:
// - Login username & password
// - PIN opsional untuk kasir
// - Lock akun setelah gagal login
// - Tracking login terakhir
//
// Role default:
// - CASHIER
// - MANAGER
// - ADMIN
//
// Relasi:
// - Store
// - Transactions
// - ActivityLogs
// - CashDrawers

// ------------------------------------------------------
// Model: Category
// ------------------------------------------------------
// Kategori produk untuk pengelompokan dan tampilan UI.
//
// Fitur:
// - Warna & ikon kategori
// - Nama kategori unik per Store
//
// Relasi:
// - Products

// ------------------------------------------------------
// Model: Product
// ------------------------------------------------------
// Produk utama yang dijual dan ditampilkan di POS & KDS.
//
// Inventaris:
// - SKU
// - Barcode
// - Stok & minimum stok
//
// Harga:
// - Harga jual
// - Harga modal
//
// Integrasi KDS:
// - Waktu persiapan
// - Kitchen station
//
// Relasi:
// - Category
// - ProductVariations
// - TransactionItems
// - Promos

// ------------------------------------------------------
// Model: ProductVariation
// ------------------------------------------------------
// Variasi produk seperti ukuran atau opsi tambahan.
//
// Fitur:
// - Harga terpisah
// - Stok terpisah
// - SKU unik per variasi
//
// Relasi:
// - Product

// ======================================================
// MODEL TRANSAKSI
// ======================================================

// ------------------------------------------------------
// Model: Transaction
// ------------------------------------------------------
// Data utama transaksi penjualan.
//
// Perhitungan:
// - Subtotal
// - Pajak
// - Diskon
// - Diskon promo
// - Total akhir
//
// Pembayaran:
// - Metode (cash, card, online)
// - Channel pembayaran
// - Payment reference
//
// Order:
// - Tipe order (dine-in, takeaway, delivery)
// - Nomor meja
//
// KDS Workflow:
// - pending -> preparing -> ready -> completed
//
// Relasi:
// - TransactionItems
// - User (cashier)
// - Store

// ------------------------------------------------------
// Model: TransactionItem
// ------------------------------------------------------
// Item detail dalam satu transaksi.
//
// Data snapshot:
// - Nama produk
// - Harga saat transaksi
// - Jumlah
//
// KDS:
// - Kitchen station
// - Status persiapan
// - Modifier / catatan
//
// Relasi:
// - Transaction
// - Product

// ------------------------------------------------------
// Model: CashDrawer
// ------------------------------------------------------
// Manajemen kas harian.
//
// Fitur:
// - Saldo awal
// - Saldo akhir
// - Perhitungan selisih
// - Catatan audit
//
// Status:
// - OPEN
// - CLOSED
//
// Relasi:
// - Store
// - User

// ======================================================
// MODEL PENDUKUNG
// ======================================================

// ------------------------------------------------------
// Model: Expense
// ------------------------------------------------------
// Pencatatan pengeluaran toko.
//
// Fitur:
// - Kategori expense
// - Nominal
// - Tanggal
// - Deskripsi
//
// Relasi:
// - Store

// ------------------------------------------------------
// Model: Promo
// ------------------------------------------------------
// Sistem promo & diskon fleksibel.
//
// Tipe promo:
// - Persentase
// - Nominal tetap
// - Buy X Get Y
//
// Target:
// - Produk
// - Kategori
// - Total keranjang
//
// Validasi:
// - Rentang tanggal
// - Jam tertentu
// - Hari tertentu
//
// Limit:
// - Maksimal penggunaan
// - Per customer
// - Minimum pembelian
//
// Relasi:
// - Products
// - Categories
// - PromoUsageLogs

// ------------------------------------------------------
// Model: PromoUsageLog
// ------------------------------------------------------
// Log penggunaan promo untuk audit & analitik.
//
// Data:
// - Promo yang digunakan
// - Transaksi
// - Customer
// - Nilai diskon
//
// Digunakan untuk:
// - Analisis performa promo
// - Audit penggunaan

// ------------------------------------------------------
// Model: Setting
// ------------------------------------------------------
// Penyimpanan konfigurasi dinamis berbasis key-value.
//
// Fitur:
// - Setting per Store
// - Satu key hanya punya satu value per Store

// ------------------------------------------------------
// Model: ActivityLog
// ------------------------------------------------------
// Audit trail aktivitas user.
//
// Data:
// - User
// - Aksi
// - Detail
// - Timestamp
//
// Optimasi:
// - Index berdasarkan user & waktu

// ======================================================
// POLA DESAIN & ARSITEKTUR
// ======================================================

// Multi-Tenancy
// ------------------------------------------------------
// Hampir semua model memiliki storeId
// untuk memastikan isolasi data antar toko.

// Referential Integrity
// ------------------------------------------------------
// Menggunakan cascade delete untuk mencegah data yatim.

// KDS Workflow
// ------------------------------------------------------
// Mendukung alur dapur:
// - Pending
// - Preparing
// - Ready
// - Completed
// Termasuk tracking waktu dan kitchen station.

// Performance
// ------------------------------------------------------
// Index strategis pada:
// - storeId
// - status transaksi
// - tanggal
// - barcode & SKU
// - promo code

// Security & Audit
// ------------------------------------------------------
// - Login aman + PIN
// - Lock akun otomatis
// - Activity log lengkap
// - Payment reference untuk rekonsiliasi


// Prisma Schema - Modern POS System with Kitchen Display System
// Database: PostgreSQL 14+

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Store {
  id            String   @id @default(cuid())
  name          String
  address       String?
  phone         String?
  email         String?
  logo          String?
  currency      String   @default("IDR")
  taxRate       Float    @default(0)
  receiptFooter String?
  primaryColor  String   @default("#3B82F6")
  licenseKey    String?  @unique
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  products       Product[]
  categories     Category[]
  transactions   Transaction[]
  expenses       Expense[]
  users          User[]
  settings       Setting[]
  activityLogs   ActivityLog[]
  promos         Promo[]
  promoUsageLogs PromoUsageLog[]
  cashDrawers    CashDrawer[]
}

model User {
  id             String    @id @default(cuid())
  username       String    @unique
  password       String
  pin            String?
  role           String    @default("CASHIER")
  fullName       String
  photo          String?
  isActive       Boolean   @default(true)
  isLocked       Boolean   @default(false)
  lockedUntil    DateTime?
  failedAttempts Int       @default(0)
  lastLogin      DateTime?
  storeId        String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  store        Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  activityLogs ActivityLog[]
  cashDrawers  CashDrawer[]

  @@index([storeId, isActive])
  @@index([role])
}

model Category {
  id        String   @id @default(cuid())
  name      String
  icon      String?
  color     String?
  storeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([storeId, name])
  @@index([storeId])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  sku         String?  @unique
  barcode     String?  @unique
  description String?
  price       Float
  cost        Float    @default(0)
  stock       Int      @default(0)
  minStock    Int      @default(5)
  image       String?
  categoryId  String?
  storeId     String
  isActive    Boolean  @default(true)
  
  // Kitchen Display System
  prepTime       Int?    @default(5) 
  kitchenStation String? @default("main") 
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store            Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category         Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  variations       ProductVariation[]
  transactionItems TransactionItem[]
  promos           Promo[]

  @@index([storeId, isActive])
  @@index([barcode])
  @@index([sku])
  @@index([categoryId])
}

model ProductVariation {
  id        String   @id @default(cuid())
  productId String
  name      String
  price     Float
  stock     Int      @default(0)
  sku       String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Transaction {
  id               String   @id @default(cuid())
  invoiceNumber    String   @unique
  subtotal         Float
  tax              Float    @default(0)
  discount         Float    @default(0)
  total            Float
  paymentMethod    String
  paymentChannel   String?
  paymentReference String?
  amountPaid       Float
  change           Float    @default(0)
  customerName     String?
  customerPhone    String?
  notes            String?

  promoCode     String?
  promoDiscount Float   @default(0)

  // Kitchen Display System fields
  orderType          String?   @default("dine-in") // 'dine-in' | 'takeaway' | 'delivery'
  tableNumber        String?
  kitchenStatus      String?   @default("pending") // 'pending' | 'preparing' | 'ready' | 'completed'
  sentToKitchenAt    DateTime?
  kitchenStartedAt   DateTime?
  kitchenCompletedAt DateTime?

  cashierId String
  storeId   String
  isSynced  Boolean @default(false)

  isReconciled Boolean   @default(false)
  reconciledAt DateTime?
  reconciledBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store   Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  cashier User              @relation(fields: [cashierId], references: [id])
  items   TransactionItem[]

  @@index([storeId, createdAt])
  @@index([invoiceNumber])
  @@index([createdAt])
  @@index([cashierId])
  @@index([promoCode])
  @@index([paymentMethod, paymentChannel])
  @@index([kitchenStatus])
  @@index([orderType])
}

model TransactionItem {
  id            String   @id @default(cuid())
  transactionId String
  productId     String
  productName   String
  quantity      Int
  price         Float
  subtotal      Float
  discount      Float    @default(0)
  notes         String?
  
  // Kitchen Display System fields
  kitchenStation String?  @default("main") 
  kitchenStatus  String?  @default("pending") 
  prepTime       Int?     @default(5) // in minutes
  modifiers      String[] @default([]) 

  createdAt     DateTime @default(now())

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  product     Product     @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([transactionId])
  @@index([kitchenStation])
  @@index([kitchenStatus])
}

model CashDrawer {
  id              String    @id @default(cuid())
  storeId         String
  cashierId       String
  openingBalance  Float     @default(0)
  closingBalance  Float?
  expectedBalance Float?
  actualBalance   Float?
  difference      Float?
  notes           String?
  openedAt        DateTime  @default(now())
  closedAt        DateTime?
  status          String    @default("OPEN") // OPEN, CLOSED

  store   Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  cashier User  @relation(fields: [cashierId], references: [id])

  @@index([storeId, status])
  @@index([cashierId])
  @@index([openedAt])
}

model Expense {
  id          String   @id @default(cuid())
  category    String
  amount      Float
  description String?
  date        DateTime @default(now())
  storeId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([storeId, date])
}

model Promo {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  description String?
  type        String
  value       Float

  minPurchase          Float    @default(0)
  maxDiscount          Float?
  applicableCategories String[] @default([])
  applicableProducts   String[] @default([])

  startDate  DateTime
  endDate    DateTime
  validDays  String[] @default([])
  validHours String?

  usageLimit       Int?
  usageCount       Int  @default(0)
  perCustomerLimit Int?

  buyQuantity  Int?
  getQuantity  Int?
  getProductId String?

  isActive  Boolean  @default(true)
  productId String?
  storeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  store   Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  logs    PromoUsageLog[]

  @@index([code])
  @@index([storeId, isActive])
  @@index([startDate, endDate])
}

model PromoUsageLog {
  id             String   @id @default(cuid())
  promoId        String
  promoCode      String
  customerPhone  String?
  transactionId  String?
  invoiceNumber  String?
  discountAmount Float
  cashierId      String
  storeId        String
  createdAt      DateTime @default(now())

  promo Promo @relation(fields: [promoId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([promoId])
  @@index([promoCode])
  @@index([customerPhone])
  @@index([createdAt])
  @@index([storeId])
}

model Setting {
  id        String   @id @default(cuid())
  key       String
  value     String
  storeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, key])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?
  storeId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}